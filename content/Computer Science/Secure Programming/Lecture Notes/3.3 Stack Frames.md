> [!idea] Stack and Function Calls
> Stacks are **first in, last out** data structures used to manage function calls. When a function is called, a new **stack frame** is created on the stack for that function's execution.
>
> Both **EBP (Base Pointer)** and **ESP (Stack Pointer)** are stored in CPU registers for quick access:
> - **EBP** points to the base of the current stack frame.
> - **ESP** points to the top of the current stack frame.
>
> As new functions are called, stack frames grow downwards in memory, with each new frame positioned below the previous one.
>
> The stack operates primarily through two operations:
> - **push**: Decrements ESP and stores a value at the new ESP location, effectively adding data to the top of the stack.
> - **pop**: Retrieves the value at the current ESP and then increments ESP, removing data from the top of the stack.
>
> **Stack at Key Stages:**
>
> 1. **Initial State: Before Function Call**
>
> | Register | Content                    |
> |----------|----------------------------|
> |          | Local variable 2 of caller |
> |          | Local variable 1 of caller |
> | EBP →    | Saved EBP of caller        |
> |          | Return address to caller's caller |
> |          | Parameter 2 for caller     |
> | ESP →    | Parameter 1 for caller     |
>
> - **EBP** points to the caller’s saved base pointer.
> - **ESP** points to the last parameter of the caller.
>
> 2. **After CALL Instruction: Transition to Callee**
>
> | Register | Content                    |
> |----------|----------------------------|
> |          | Local variable 2 of caller |
> |          | Local variable 1 of caller |
> | EBP →    | Saved EBP of caller        |
> |          | Return address to caller's caller |
> |          | Parameter 2 for caller     |
> |          | Parameter 1 for caller     |
> |          | Argument 2 for callee      |
> |          | Argument 1 for callee      |
> | ESP →    | Return address to caller   |
>
> - The caller pushes the arguments for the callee onto the stack.
> - The **CALL** instruction pushes the return address onto the stack, and **ESP** points to this address.
>
> 3. **Callee's Frame Established: After Prologue**
>
> | Register | Content                    |
> |----------|----------------------------|
> |          | Local variable 2 of caller |
> |          | Local variable 1 of caller |
> |          | Saved EBP of caller        |
> |          | Return address to caller's caller |
> |          | Parameter 2 for caller     |
> |          | Parameter 1 for caller     |
> |          | Argument 2 for callee      |
> |          | Argument 1 for callee      |
> |          | Return address to caller   |
> | EBP →    | Saved EBP of callee        |
> | ESP →    | Local variable 1 of callee |
>
> - The callee’s prologue pushes the current EBP (from the caller) onto the stack and sets EBP to the current value of ESP.
> - **ESP** is decremented to allocate space for the callee's local variables.
>
> 4. **Return to Caller: After Callee's Epilogue**
>
> | Register | Content                    |
> |----------|----------------------------|
> |          | Local variable 2 of caller |
> |          | Local variable 1 of caller |
> | EBP →    | Saved EBP of caller        |
> |          | Return address to caller's caller |
> |          | Parameter 2 for caller     |
> |          | Parameter 1 for caller     |
> | ESP →    | Return value from callee   |
>
> - The callee's epilogue restores ESP to the value of EBP, effectively deallocating the callee’s local variables.
> - The old EBP is popped, restoring the caller's EBP.
> - The **RET** instruction pops the return address from the stack, and control returns to the caller.
