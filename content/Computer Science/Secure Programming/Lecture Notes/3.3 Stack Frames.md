> [!idea] Stack and Function Calls
> Stacks are **first in, last out** data structures well suited to containing data used by processes. When a function is called, a dedicated space called a **stack frame** is created on the stack to hold the function's local variables and parameters.
> 
> Two crucial pointers manage this space:
> - The **EBP (Base Pointer)** points to the top of the current stack frame.
> - The **ESP (Stack Pointer)** points to the bottom of the current stack frame.
> 
> Both EBP and ESP are stored in CPU registers for quick access. As new functions are called, stack frames grow downwards in memory, with each new frame positioned below the previous one.
> 
> The stack operates primarily through two operations:
> - **push** decrements the ESP and stores a value at the new ESP location, effectively adding data to the bottom of the stack.
> - **pop** retrieves the value at the current ESP and then increments ESP, removing data from the bottom of the stack.
> 
> When a function is called:
> 1. The arguments for the function are pushed onto the stack.
> 2. The return address (address of the next instruction after the function call) is pushed onto the stack.
> 3. The current EBP (of the calling function) is pushed onto the stack.
> 4. EBP is set to the current ESP value, establishing a new base for the called function.
> 5. Space for local variables is allocated by decrementing ESP.
> 
> When a function is called, the stack looks like this:
> 
> | Pointer | Value |
> |---------|-------|
> |         | Argument 1 |
> |         | Argument 2 |
> |         | ... |
> |         | Argument n |
> |         | Return Address |
> | EBP →   | Old EBP |
> |         | ... |
> | ESP →   | Local variables |
> 
> When a function completes:
> 1. The return value is typically stored in a designated register (often EAX).
> 2. ESP is moved back to EBP, effectively deallocating local variables.
> 3. The previous EBP value is popped from the stack, restoring the caller's stack frame.
> 4. The return address is popped, transferring control back to the calling function.
> 5. The calling function adjusts ESP to remove any pushed arguments.
> 
> Just before a function returns, the stack looks like this:
> 
> | Pointer | Value |
> |---------|-------|
> |         | Argument 1 |
> |         | Argument 2 |
> |         | ... |
> |         | Argument n |
> |         | Return Address |
> | EBP →   | Old EBP |
> | ESP →   | Old EBP |
> 
> This process ensures that the stack is properly maintained and that control is correctly returned to the calling function, with the stack in the same state it was before the function call.

