various improvements from seraphys' working branch
