## 1. Manual Code Review

### Architecture and Design

| **Aspect**                            | **Status**  | **Comments**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ------------------------------------- | ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Protocol Implementation Adherence** | Not Adhered | The codebase shows significant deviations from the OLAF/Neighbourhood protocol specifications. Key discrepancies include:<br><br>1. **Message Signing**: The protocol specifies that messages should be signed using RSA-PSS with SHA-256, and the signature should be the Base64-encoded result of signing the concatenation of the data JSON and the counter. However, the code uses a simple SHA-256 hash of the data concatenated with the counter and then Base64-encodes it, without using the private key for RSA-PSS signing. This does not provide the necessary cryptographic assurance specified by the protocol.<br><br>2. **Counter Handling**: The protocol requires that message counters be monotonically increasing integers to prevent replay attacks. While the code includes a counter, there is no implementation for tracking and verifying the counters of incoming messages to ensure they are greater than the previous value, as required by the protocol.<br><br>3. **Cryptographic Specifications**: The code does not adhere to the specified cryptographic parameters. For instance, AES keys are generated with a length of 32 bytes (256 bits), whereas the protocol specifies a key length of 16 bytes (128 bits). Additionally, the code uses PyCrypto, which is deprecated, instead of a current cryptographic library.<br><br>4. **Message Structures**: Some message formats deviate from the protocol. For example, the `public_chat` message in the code includes a `sender` field with the `fingerprint`, but this has been implemented as signed data.<br><br>5. **Error Handling and Protocol Compliance**: The code assumes well-formed inputs and lacks comprehensive validation of incoming messages against the protocol specifications. This can lead to unexpected behavior when messages do not conform exactly to the expected format. |

### Code Quality

| **Aspect**                       | **Status**        | **Comments**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -------------------------------- | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Readability and Organization** | Poor Organization | The codebase is disorganized and difficult to navigate. It contains code from previous iterations that are not relevant to the current implementation, leading to confusion. There is a lack of modularization, and functions are not well-separated or documented. The absence of a README or documentation makes it challenging to understand how to set up and run the application. Hardcoded addresses and ports are scattered throughout the code, making it inflexible and hard to configure for different environments. Overall, the code lacks structure and clarity, impeding maintainability and scalability. |
| **Error Handling and Logging**   | Inadequate        | Error handling is insufficient and inconsistent. The application will almost **certainly** crash when unexpected inputs are provided or when network errors occur, without graceful recovery or informative error messages. Logging is minimal, relying primarily on print statements that are not systematically used throughout the code. This makes debugging and monitoring the application difficult. Critical errors are not properly caught, and exceptions can lead to the application terminating unexpectedly, which poses reliability and security concerns.                                                 |

### Security-specific Checks

| **Aspect**                               | **Status**                 | **Comments**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ---------------------------------------- | -------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Input Validation**                     | Massive Threat Vector      | There is minimal input validation across the application. User inputs are not properly sanitized or validated. The code assumes well-formed inputs, which is not safe in a production environment. For example, message parsing relies on searching for substrings within user input to determine the type of message to send (e.g., using `find` on "public:"). This method is dangerous because if a user includes certain keywords in their message unintentionally, it could trigger unintended behaviors, such as broadcasting a private message publicly. This represents a significant security and privacy concern.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Access Control**                       | ❌ Missing                  | The application lacks proper access control mechanisms. Any user can connect to the server without authentication, and there are no checks to prevent unauthorized actions.  Additionally, multiple clients can connect using the same public key, which should not be permitted, as each client should have a unique key pair to ensure proper identification and secure communication.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Cryptographic Implementations**        | ❌ Incorrect Implementation | The cryptographic implementations in the code do not fully comply with the protocol specifications:<br><br>1. **Message Signing**: The protocol requires RSA-PSS with SHA-256 for digital signatures. The code, however, uses a simple SHA-256 hash of the data concatenated with the counter, without involving the private key for signing. This means that message signatures are not secure, as anyone can compute the SHA-256 hash without possessing the private key.<br><br>2. **AES Key Length and Mode**: The code generates AES keys of 32 bytes (256 bits), whereas the protocol specifies a key length of 16 bytes (128 bits). Although AES-256 is secure, deviating from the protocol can cause interoperability issues. Additionally, the code uses AES in GCM mode, which aligns with the protocol.<br><br>3. **Use of Deprecated Libraries**: The code imports `AES` and `get_random_bytes` from the `Crypto` library (PyCrypto), which is deprecated and no longer maintained. This poses security risks due to potential unpatched vulnerabilities. The protocol suggests using current and secure libraries for cryptographic operations.<br><br>4. **Fingerprint Calculation**: The code calculates the fingerprint by hashing the PEM-encoded public key and then Base64-encoding it, which aligns with the protocol's definition. This aspect appears to be correctly implemented.<br><br>Overall, the incorrect implementation of cryptographic operations undermines the security guarantees provided by the protocol. |
| **Secure Data Storage and Transmission** | ❌ Insecure Transmission    | Data transmission is insecure due to the use of hardcoded addresses and ports, which cannot be easily configured for secure channels. The application communicates over unencrypted WebSocket connections (`ws://`), without using TLS (`wss://`), leaving the data susceptible to interception. Additionally, public chats are non-functional, and when attempted, they do not work correctly, indicating issues with data handling and transmission. Private chats are also not fully implemented or are unreliable due to the aforementioned cryptographic issues. The lack of secure communication protocols undermines the confidentiality and integrity of the data exchanged between clients and the server.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |

## 2. Static Analysis

The static analysis was performed using **Bandit**, a security-oriented static analysis tool for Python. Below are the findings from the analysis of `chat_server.py`:

| Issue | Severity | Confidence | Location          | Description                                                                                    | Recommendation                                                                                                                                            | More Info                                                                                                |
| ----- | -------- | ---------- | ----------------- | ---------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| B404  | Low      | High       | chat_server.py:4  | Usage of the `subprocess` module can lead to security vulnerabilities if not handled properly. | Avoid using subprocess with untrusted input or ensure that all inputs are properly sanitized.                                                             | [Link](https://bandit.readthedocs.io/en/latest/blacklists/blacklist_imports.html#b404-import-subprocess) |
| B603  | Low      | High       | chat_server.py:71 | Subprocess calls without `shell=True` can be exploited if untrusted input is passed.           | Avoid using `subprocess.run` with untrusted input or use safer alternatives. If `shell=True` is necessary, ensure that the input is thoroughly sanitized. | [Link](https://bandit.readthedocs.io/en/latest/plugins/b603_subprocess_without_shell_equals_true.html)   |
| B603  | Low      | High       | chat_server.py:76 | Same as above.                                                                                 | Same as above.                                                                                                                                            | [Link](https://bandit.readthedocs.io/en/latest/plugins/b603_subprocess_without_shell_equals_true.html)   |

## 3. Dynamic Analysis

The provided code is unfinished and poorly documented, so dynamic analysis was not suitable for this review. The reviewer did attempt to get the application running and send messages, however, most of the protocol remains in a placeholder state so nothing substantial can be said about the application. 

## 4. Backdoor/Vulnerability Assessment

Note that the following vulnerabilities are only *theoretically* possible because the application seems mostly unfinished and doesn't actually implement the protocol. The reviewer has written this section under the implication that these functions exist and operate in a finished implementation.

1. **Subprocess Command Execution:**
   - **Location:** `encrypt_message_cpp` and `decrypt_message_cpp` functions.
   - **Description:** These functions utilize `subprocess.run` to execute external encryption/decryption programs. This allows for the execution of arbitrary commands if user input is not properly sanitized.
   - **Example:** A malicious user could send a specially crafted message that includes shell commands, potentially leading to remote code execution. For instance, sending a message like `"; rm -rf / #` could exploit the subprocess call to delete critical server files.

2. **Vulnerable Authentication Mechanism:**
   - **Location:** `vulnerable_authentication` function.
   - **Description:** The authentication function uses hardcoded credentials (`username == "admin" && password == "password"`), making it trivial for attackers to gain unauthorized access.
   - **Example:** An attacker can easily bypass authentication by using the known credentials, gaining access to administrative functionalities or sensitive data. This could *potentially* allow the attacker to send fraudulent messages, manipulate user lists, or disrupt the chat service.

3. **Lack of Proper Encryption:**
   - **Location:** Throughout the message handling functions.
   - **Description:** Messages, especially public chats, are sent in plaintext without proper encryption, contrary to the protocol's specifications. This allows any eavesdropper to read the messages easily.
   - **Example:** An attacker monitoring the network traffic can intercept and read all public chat messages, compromising user privacy and the integrity of communications.

## 5. Results Summary

| **Category**            | **Details**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|-------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Strengths**           | - **Basic Functionality:** The code includes initial setups like a WebSocket server and basic message handling functions.<br>- **Understanding of Chat Application Needs:** Shows awareness of features like message sending and client management.                                                                                                                                                                                                                                                                                                                                                                             |
| **Areas for Improvement** | - **Protocol Non-Adherence:** Does not implement the OLAF/Neighbourhood protocol, missing essential features like message signing and proper encryption.<br>- **Security Shortcomings:** Lacks proper authentication, encryption, and input validation; uses hardcoded credentials and insecure subprocess calls.<br>- **Code Organization:** Poor structure with scattered functions and placeholder implementations; lacks modularity and clear separation of concerns.<br>- **Error Handling:** Minimal and inconsistent error handling; insufficient logging for debugging and monitoring. |
| **Critical Issues**     | - **Insecure Authentication:** Hardcoded credentials in `vulnerable_authentication` function pose a high security risk.<br>- **Unsafe Subprocess Usage:** `encrypt_message_cpp` and `decrypt_message_cpp` functions use subprocess calls that can be exploited for code injection.<br>- **Plaintext Transmission:** Messages are sent without encryption, exposing them to interception and violating protocol requirements.<br>- **Lack of Input Validation:** Increases susceptibility to injection attacks and processing of malicious data.                                                                 |

## 6. Recommendations

| **Recommendation Category**     | **Actions**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|---------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Implement Protocol Specifications** | - Fully adhere to the OLAF/Neighbourhood protocol, including message signing, end-to-end encryption with RSA and AES-GCM, and correct message routing.                                                                                                                                                                                                                                                                                                                                         |
| **Enhance Security Measures**           | - Replace hardcoded credentials with a secure authentication system using hashed and salted passwords.<br>- Sanitize and validate all user inputs to prevent injection attacks.<br>- Secure subprocess calls or replace them with safe, integrated cryptographic functions.<br>- Use secure WebSocket connections (`wss://`) to encrypt data in transit.                                                                                                                                                              |
| **Improve Code Quality**                | - Refactor the codebase for better organization, separating concerns into modules or classes.<br>- Remove placeholder functions and implement fully functional features.<br>- Introduce robust error handling and comprehensive logging mechanisms.                                                                                                                                                                                                                                              |
| **Conduct Comprehensive Testing**       | - Perform thorough static analysis with tools like Bandit to identify and fix vulnerabilities.<br>- Carry out dynamic analysis, including penetration testing and fuzzing, to uncover runtime issues.<br>- Implement unit and integration tests to ensure all components function correctly.<br>- Regularly conduct peer code reviews to maintain code quality and security standards.                                                                                                                    |
